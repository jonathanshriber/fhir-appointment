<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Example SMART App</title>
        <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <style>
            #patient, #appointments, #slots {
                font-family: Monaco, monospace;
                white-space: pre;
                font-size: 13px;
                height: 30vh;
                overflow: scroll;
                border: 1px solid #CCC;
            }

            body {
                font-family:Verdana, Geneva, Tahoma, sans-serif;
                font-size: 14px;

            } 
            table, th, td {
              border: 1px solid black;
              border-collapse: collapse;
              font-size: 14px;
            }
            th, td {
              padding: 5px;
            }

        </style>

        <script language="javascript">

            var patientId = "";

            var serviceTypeDict = {"EVisit": "https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|2572307909", 
                                   "Well Child Check": "https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|25367387",
                                   "Video Visit": "https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|2572307911"};

            var blankAppointment = {
                "resourceType": "Appointment",
                "status": "proposed",
                "comment": "Appointment request comment",
                "participant": [
                    {
                    "actor": {
                        "reference": ""
                    },
                    "status": "needs-action"
                    }
                ],
                "slot": [{
                    "reference": ""
                }]
            };

            function GetSlotsTable(slotsData)
            {
                var html = `
                <table>
                    <tr>
                        <th>Service Type
                            <select id="serviceType">
                                <option value'EVisit'>EVisit</option>
                                <option value='Well Child Check'>Well Child Check</option>
                                <option value='Video Visit'>Video Visit</option>
                            </select>
                        </th>
                        <th>Slot ID</th>
                        <th>Start <input type="date" id="startDate" name="startDate"></th>
                        <th>End <input type="date" id="endDate" name="endDate"></th>
                        <th>Status</th>
                    </tr>
                    `;
                slotsData.forEach(slot => {
                    html += '<tr>';
                    html += '<td>' + getServiceType(slot) + '</td>'; 
                    html += '<td>' + slot.resource.id + '</td>';
                    //html += '<td>' + slot.resource.schedule.reference + '</td>';
                    html += '<td>' + formatDate_mmddyyyy_hhmm(slot.resource.start) + '</td>';
                    html += '<td>' + formatDate_mmddyyyy_hhmm(slot.resource.end) + '</td>';
                    html += '<td><a onclick="MakeAppointment(\'' + slot.resource.id + '\')" href="#">' + slot.resource.freeBusyType + '</a></td>';
                    html +='</tr>'
                });
                html += '</table>';
                $("#slotsTable").html(html);
            }

            function getServiceType(slot)
            {
                var serviceDesc = "";
                var len = slot.resource.type.coding.length;
                if(len > 0)
                    serviceDesc = slot.resource.type.coding[len-1].display;

                return serviceDesc;
            }

            // return YYYY-MM-DD 00:00
            function formatDate_mmddyyyy_hhmm(dateString)
            {
                var d = new Date(dateString);
                return ((d.getUTCMonth()+1) < 10 ? '0' + (d.getUTCMonth()+1) : (d.getUTCMonth()+1)) + 
                    "/" + (d.getUTCDate() < 10 ? '0' + d.getUTCDate() : d.getUTCDate() ) + 
                    "/" + d.getUTCFullYear() +
                    " " + (d.getUTCHours() < 10 ? '0' + d.getUTCHours() : d.getUTCHours() )+ 
                    ":" + (d.getUTCMinutes() < 10 ? '0' + d.getUTCMinutes() : d.getUTCMinutes() );
            }

            // return YYYY-MM-DD
            function formatDate_yyyymmdd(dateString)
            {
                var d = new Date(dateString);
                return d.getUTCFullYear() + 
                    "-" + ((d.getUTCMonth()+1) < 10 ? '0' + (d.getUTCMonth()+1) : (d.getUTCMonth()+1)) +
                    "-" + (d.getUTCDate() < 10 ? '0' + d.getUTCDate() : d.getUTCDate());
            }
            
            // return YYYY-MM-DDT00:00:00.000Z
            function formatDate_yyyymmdd_zeroHour(dateString)
            {
                var d = new Date(dateString);
                return d.getUTCFullYear() + 
                    "-" + ((d.getUTCMonth()+1) < 10 ? '0' + (d.getUTCMonth()+1) : (d.getUTCMonth()+1)) +
                    "-" + (d.getUTCDate() < 10 ? '0' + d.getUTCDate() : d.getUTCDate()) +
                    "T00:00:00.000Z";
            }                    

            function MakeAppointment(slotId)
            {
                alert(slotId);
                var newAppointment = blankAppointment;
                newAppointment.participant[0].actor.reference = "Patient/" + patientId;
                newAppointment.slot[0].reference = "Slot/" + slotId;

                FHIR.oauth2.ready().then(function(client) {
                    client.create(newAppointment, {})
                    .then(
                        function(appData) {
                        console.log(appData);
                        document.getElementById("appointmentDiv").innerHTML = appData.text.div;

                        client.request("/Slot?_id=" + slotId, {})
                        // Reject if no Slot is found
                        .then(function(slotData) {
                            if (!slotData.entry || !slotData.entry.length) {
                                throw new Error("No slot found for id " + slotId);
                            }
                            if(slotData.entry.length > 0)
                                document.getElementById("slotDiv").innerHTML = slotData.entry[0].resource.text.div;
                        });
                    });



                }).catch(console.error);
            }

            function GetPatientInContext()
            {
                FHIR.oauth2.ready().then(function(client) {
                    
                    // Render the current patient (or any error)
                    client.patient.read().then(
                        function(pt) {
                            document.getElementById("patient").innerText = JSON.stringify(pt, null, 4);
                            patientId = pt.id;
                        },
                        function(error) {
                            document.getElementById("patient").innerText = error.stack;
                        }
                    );
                }).catch(console.error);
            }

            function GetSlots()
            {
                var startDate;
                var endDate;
                var today = new Date();
                var tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);

                // get start date
                var start = document.getElementById("startDate");
                if(start == null)
                    startDate = today
                else
                    startDate = document.getElementById("startDate").value;

                // get end date
                var end = document.getElementById("endDate");
                if(end == null)
                    endDate = tomorrow;
                else
                    endDate = document.getElementById("endDate").value;

                // get service/slot type
                var service = document.getElementById("serviceType");
                var serviceType;
                if(service == null)
                    serviceType = 'EVisit'
                else
                    serviceType = service.options[service.selectedIndex].text;

                // get Slot
                var slotQuery = "/Slot?";
                //slotQuery += "slot-type=https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|25367387" + "&";
                slotQuery += "slot-type=" + serviceTypeDict[serviceType] + "&";
                slotQuery += "start=ge" + formatDate_yyyymmdd_zeroHour(startDate) + "&";
                slotQuery += "start=lt" + formatDate_yyyymmdd_zeroHour(endDate);
                alert(slotQuery);

                FHIR.oauth2.ready().then(function(client) {
                    client.request(slotQuery, {})

                    // Reject if no Slots are found
                    .then(function(data) {
                        if (!data.entry || !data.entry.length) {
                            throw new Error("No slots found for the selected patient");
                        }
                        return data.entry;
                    })

                    // Render the slots (or any error)
                    .then(
                        function(slots) {
                            document.getElementById("slots").innerText = JSON.stringify(slots, null, 4);
                            GetSlotsTable(slots);

                            // set date control values
                            document.getElementById("startDate").value = formatDate_yyyymmdd(startDate);
                            document.getElementById("endDate").value = formatDate_yyyymmdd(endDate);

                            // set service/slot type control value
                            document.getElementById("serviceType").value = serviceType;
                        },
                        function(error) {
                            document.getElementById("slots").innerText = error.stack;
                        }
                    );
                }).catch(console.error);
            }

        </script>

    </head>
    <body onload="GetPatientInContext(); GetSlots()">


        <table style="width: 100%">
            <colgroup>
               <col span="1" style="width: 33%;">
               <col span="1" style="width: 33%;">
               <col span="1" style="width: 34%;">
            </colgroup>
            <tbody>
                <tr>
                    <td><div id="appointmentDiv"></div></td>
                    <td><div id="slotDiv"></div></td>
                    <td><div id="scheduleDiv"></div></td>
                </tr>
            </tbody>
        </table>



        
        <br/>        
        <input type="button" value="Get Slots" onclick="GetSlots()">
        <br/>
        <div id="slotsTable"></div>
        <br/>
        <h4>Current Patient</h4>
        <div id="patient">Loading...</div>
        <br/>
        <h4>Appointments</h4>
        <div id="appointments">Loading...</div>
        <br/>
        <h4>Slots</h4>
        <div id="slots">Loading...</div>

        <script type="text/javascript">
            // FHIR.oauth2.ready().then(function(client) {
                
            //     // Render the current patient (or any error)
            //     client.patient.read().then(
            //         function(pt) {
            //             document.getElementById("patient").innerText = JSON.stringify(pt, null, 4);
            //             patientId = pt.id;
            //         },
            //         function(error) {
            //             document.getElementById("patient").innerText = error.stack;
            //         }
            //     );
                
            //     // get created Appointment
            //     //client.request("/Appointment?patient=" + client.patient.id + "&_id=4829518", {})
            //     client.request("/Appointment?_id=4829518", {})

            //     // Reject if no Appointments are found
            //     .then(function(data) {
            //         if (!data.entry || !data.entry.length) {
            //             throw new Error("No appointments found for the selected patient");
            //         }
            //         return data.entry;
            //     })

            //     // Render the current patient's appointments (or any error)
            //     .then(
            //         function(appts) {
            //             document.getElementById("appointments").innerText = JSON.stringify(appts, null, 4);
            //         },
            //         function(error) {
            //             document.getElementById("appointments").innerText = error.stack;
            //         }
            //     );

            // }).catch(console.error);
                        
        </script>
    </body>
</html> 