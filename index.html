<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Example SMART App</title>
        <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <style>
            #patientJson, #appointmentJson, #slotJson, #scheduleJson, #slotsJson, #apptsJson {
                font-family: Monaco, monospace;
                white-space: pre;
                font-size: 13px;
                height: 30vh;
                overflow: scroll;
                border: 1px solid #CCC;
            }

            body {
                font-family:Verdana, Geneva, Tahoma, sans-serif;
                font-size: 14px;

            } 
            table.slot{
              border: 1px solid black;
              border-collapse: collapse;
              font-size: 14px;
            }
            td.slotRow {
              border: 1px solid black;
              border-collapse: collapse;
              padding: 5px;
            }
            th.slotHeader {
              border: 1px solid black;
              border-collapse: collapse;
              padding: 5px;
            }
            table.appt{
              border: 1px solid black;
              border-collapse: collapse;
              font-size: 14px;
            }
            td.apptRow {
              border-collapse: collapse;
              padding: 5px;
            }
            th.apptHeader {
              border: 1px solid black;
              border-collapse: collapse;
              padding: 5px;
            }            
            span {
                font-family: Monaco, monospace;
                font-size: 18px;
            }  
            span.label {
                font-weight: bold;
            }            

        </style>

        <script language="javascript">

            var patientId = "";
            var startDate;
            var endDate;

            var serviceTypeDict = {"EVisit": "https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|2572307909", 
                                   "Well Child Check": "https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|25367387",
                                   "Video Visit": "https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|2572307911"};

            var blankAppointment = {
                "resourceType": "Appointment",
                "status": "proposed",
                "comment": "Appointment request comment",
                "participant": [
                    {
                    "actor": {
                        "reference": ""
                    },
                    "status": "needs-action"
                    }
                ],
                "slot": [{
                    "reference": ""
                }]
            };

            function DrawSlotsTable(slotsData)
            {
                var html = `
                <table class="slot">
                    <tr>
                        <th class="slotHeader">Service Type
                            <select id="serviceType">
                                <option value'EVisit'>EVisit</option>
                                <option value='Well Child Check'>Well Child Check</option>
                                <option value='Video Visit'>Video Visit</option>
                            </select>
                        </th>
                        <th class="slotHeader">Slot ID</th>
                        <th class="slotHeader">Start<input type="date" id="startDate" name="startDate"></th>
                        <th class="slotHeader">End<input type="date" id="endDate" name="endDate"></th>
                        <th class="slotHeader">Actor</th>
                        <th class="slotHeader">Location</th>
                        <th class="slotHeader">Status</th>
                    </tr>
                    `;
                slotsData.forEach(slot => {
                    html += '<tr>';
                    html += '<td class="slotRow">' + getServiceType(slot) + '</td>'; 
                    html += '<td class="slotRow">' + slot.resource.id + '</td>';
                    html += '<td class="slotRow">' + formatDate_mmddyyyy_hhmm(slot.resource.start) + '</td>';
                    html += '<td class="slotRow">' + formatDate_mmddyyyy_hhmm(slot.resource.end) + '</td>';
                    html += '<td class="slotRow">' + slot.resource.schedule.actor.display + '</td>';
                    html += '<td class="slotRow">' + slot.resource.schedule.extension[0].valueReference.display + '</td>';
                    html += '<td class="slotRow"><a onclick="MakeAppointment(\'' + slot.resource.id + '\')" href="#">' + slot.resource.freeBusyType + '</a></td>';
                    html +='</tr>'
                });
                html += '</table>';
                $("#slotsTable").html(html);
            }

            function DrawAppointmentsTable(apptsData)
            {
                //var html = '<table class="appt">';

                var html = `
                <table class="appt">
                    <tr>
                        <th class="apptHeader">Appointment Type</th>
                        <th class="apptHeader">Practitioner</th>
                        <th class="apptHeader">Start</th>
                        <th class="apptHeader">End</th>
                    </tr>
                    `;
                apptsData.forEach(appt => {
                    html += '<tr>';
                    html += '<td class="apptRow">' + appt.resource.type.text + '</td>';
                    appt.resource.participant.forEach(p => {
                        if(p.actor.reference != null && p.actor.reference.includes("Practitioner"))
                            html += '<td class="apptRow">' + p.actor.display + '</td>';
                        else
                        html += '<td class="apptRow"></td>';
                    });
                    html += '<td class="apptRow">' + formatDate_mmddyyyy_hhmm(appt.resource.start) + '</td>';
                    html += '<td class="apptRow">' + formatDate_mmddyyyy_hhmm(appt.resource.end) + '</td>';
                    html +='</tr>'
                });
                html += '</table>';
                $("#apptsTable").html(html);
            }

            function getServiceType(slot)
            {
                var serviceDesc = "";
                var len = slot.resource.type.coding.length;
                if(len > 0)
                    serviceDesc = slot.resource.type.coding[len-1].display;

                return serviceDesc;
            }

            // return YYYY-MM-DD 00:00
            function formatDate_mmddyyyy_hhmm(dateString)
            {
                var d = new Date(dateString);
                return ((d.getUTCMonth()+1) < 10 ? '0' + (d.getUTCMonth()+1) : (d.getUTCMonth()+1)) + 
                    "/" + (d.getUTCDate() < 10 ? '0' + d.getUTCDate() : d.getUTCDate() ) + 
                    "/" + d.getUTCFullYear() +
                    " " + (d.getUTCHours() < 10 ? '0' + d.getUTCHours() : d.getUTCHours() )+ 
                    ":" + (d.getUTCMinutes() < 10 ? '0' + d.getUTCMinutes() : d.getUTCMinutes() );
            }

            // return YYYY-MM-DD
            function formatDate_yyyymmdd(dateString)
            {
                var d = new Date(dateString);
                return d.getUTCFullYear() + 
                    "-" + ((d.getUTCMonth()+1) < 10 ? '0' + (d.getUTCMonth()+1) : (d.getUTCMonth()+1)) +
                    "-" + (d.getUTCDate() < 10 ? '0' + d.getUTCDate() : d.getUTCDate());
            }
            
            // return YYYY-MM-DDT00:00:00.000Z
            function formatDate_yyyymmdd_zeroHour(dateString)
            {
                var d = new Date(dateString);
                return d.getUTCFullYear() + 
                    "-" + ((d.getUTCMonth()+1) < 10 ? '0' + (d.getUTCMonth()+1) : (d.getUTCMonth()+1)) +
                    "-" + (d.getUTCDate() < 10 ? '0' + d.getUTCDate() : d.getUTCDate()) +
                    "T00:00:00.000Z";
            }                    

            function MakeAppointment(slotId)
            {
                alert("Make appointment for slot " + slotId);
                var newAppointment = blankAppointment;
                newAppointment.participant[0].actor.reference = "Patient/" + patientId;
                newAppointment.slot[0].reference = "Slot/" + slotId;

                FHIR.oauth2.ready().then(function(client) {
                    // create the Appointment
                    client.create(newAppointment, {})
                    .then(
                        function(appData) {
                        console.log(appData);
                        
                        // echo the appointment
                        document.getElementById("appointmentDiv").innerHTML = appData.text.div;
                        document.getElementById("appointmentJson").innerText = JSON.stringify(appData, null, 4);

                        // Now get the Slot
                        client.request("/Slot?_id=" + slotId, {})
                        // Reject if no Slot is found
                        .then(function(slotData) {
                            if (!slotData.entry || !slotData.entry.length) {
                                throw new Error("No slot found for id " + slotId);
                            }
                            if(slotData.entry.length > 0)
                            {
                                document.getElementById("slotDiv").innerHTML = slotData.entry[0].resource.text.div;
                                document.getElementById("slotJson").innerText = JSON.stringify(slotData, null, 4);

                                // Now get the Schedule
                                client.request("/" + slotData.entry[0].resource.schedule.reference, {})
                                // Reject if no Schedule is found
                                .then(function(scheduleData) {
                                    if (!scheduleData) {
                                        throw new Error("No schedule found for id " + slotId);
                                    }
                                    document.getElementById("scheduleDiv").innerHTML = scheduleData.text.div;
                                    document.getElementById("scheduleJson").innerText = JSON.stringify(scheduleData, null, 4);
                                });                                
                            }
                        });
                    });
                }).catch(console.error);
            }

            function GetPatientInContext(client)
            {
                FHIR.oauth2.ready().then(function(client) {
                    
                    // Render the current patient (or any error)
                    client.patient.read().then(
                        function(pt) {
                            document.getElementById("patientJson").innerText = JSON.stringify(pt, null, 4);
                            document.getElementById("patientName").innerHTML = pt.name[0].text;
                            patientId = pt.id;
                        },
                        function(error) {
                            document.getElementById("patientJson").innerText = error.stack;
                        }
                    );
                }).catch(console.error);
            }

            function GetAppointmentsForPatient(client)
            {
                // Appointment request query string ex: /Appointment?patient=12724065&date=ge2021-08-10T00:00:00.000-05:00&date=lt2021-08-11T00:00:00.000-05:00&_format=json
                var apptQuery = "/Appointment?patient=";
                FHIR.oauth2.ready().then(function(client) {
                    client.patient.read().then(
                        function(pt) {
                            apptQuery += pt.id;
                            apptQuery += "&";
                            var today = new Date();
                            var tomorrow = new Date();
                            tomorrow.setDate(today.getDate() + 1);
                            apptQuery += "date=ge" + formatDate_yyyymmdd_zeroHour((startDate == null) ? today : startDate) + "&";
                            apptQuery += "date=lt" + formatDate_yyyymmdd_zeroHour((endDate == null) ? tomorrow : endDate);                            
                            client.request(apptQuery, {})
                            .then(function(data) {
                                if (!data.entry || !data.entry.length) {
                                    throw new Error("No appointments found.");
                                }
                                return data.entry;
                            })                    
                            .then(
                                function(appts) {
                                    // echo Appointments JSON
                                    document.getElementById("apptsJson").innerText = JSON.stringify(appts, null, 4);
                                    DrawAppointmentsTable(appts);
                                },
                                function(error) {
                                    document.getElementById("apptsJson").innerText = error.stack;
                                }
                            );
                        },
                        function(error) {
                            document.getElementById("patientJson").innerText = error.stack;
                        }
                    )
                }).catch(console.error);
            }

            function GetSlots(client)
            {
                //var startDate;
                //var endDate;
                var today = new Date();
                var tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);

                // get start date
                var start = document.getElementById("startDate");
                if(start == null)
                    startDate = today
                else
                    startDate = document.getElementById("startDate").value;

                // get end date
                var end = document.getElementById("endDate");
                if(end == null)
                    endDate = tomorrow;
                else
                    endDate = document.getElementById("endDate").value;

                // get service/slot type
                var service = document.getElementById("serviceType");
                var serviceType;
                if(service == null)
                    serviceType = 'EVisit'
                else
                    serviceType = service.options[service.selectedIndex].text;

                // Slot request query string ex: Slot?slot-type=https://fhir.cerner.com/ec2458f2-1e24-41c8-b71b-0e701af7583d/codeSet/14249|2572307909&start=ge2021-07-29T00:00:00.000Z&start=lt2021-07-30T00:00:00.000Z
                var slotQuery = "/Slot?";
                slotQuery += "slot-type=" + serviceTypeDict[serviceType] + "&";
                slotQuery += "start=ge" + formatDate_yyyymmdd_zeroHour(startDate) + "&";
                slotQuery += "start=lt" + formatDate_yyyymmdd_zeroHour(endDate);
                //alert(slotQuery);

                // get Slot
                FHIR.oauth2.ready().then(function(client) {
                    client.request(slotQuery, {resolveReferences: ["schedule"]})

                    // Reject if no Slots are found
                    .then(function(data) {
                        if (!data.entry || !data.entry.length) {
                            throw new Error("No slots found.");
                        }
                        return data.entry;
                    })

                    // Render the slots (or any error)
                    .then(
                        function(slots) {
                            // echo Slots JSON
                            document.getElementById("slotsJson").innerText = JSON.stringify(slots, null, 4);
                            
                            // show the selected slots
                            DrawSlotsTable(slots);

                            // set date control values
                            document.getElementById("startDate").value = formatDate_yyyymmdd(startDate);
                            document.getElementById("endDate").value = formatDate_yyyymmdd(endDate);

                            // set service/slot type control value
                            document.getElementById("serviceType").value = serviceType;
                        },
                        function(error) {
                            document.getElementById("slotsJson").innerText = error.stack;
                        }
                    );
                }).catch(console.error);
            }

        </script>

    </head>
    <body onload="FHIR.oauth2.ready().then(function(client){GetPatientInContext(client); GetAppointmentsForPatient(client); GetSlots(client);})">
        <span class="label">Patient:&nbsp;</span><span id="patientName"></span>
        <br>
        <div id="apptsTable"></div>
        <br>
        <hr>
        <br>
        <table class="fhirResource" style="width: 100%">
            <colgroup>
               <col span="1" style="width: 33%;">
               <col span="1" style="width: 33%;">
               <col span="1" style="width: 34%;">
            </colgroup>
            <tbody>
                <tr>
                    <td style="vertical-align:top"><div id="appointmentDiv"></div></td>
                    <td style="vertical-align:top"><div id="slotDiv"></div></td>
                    <td style="vertical-align:top"><div id="scheduleDiv"></div></td>
                </tr>
            </tbody>
        </table>
        <br/>        
        <input type="button" value="Get Slots" onclick="GetSlots()">
        <br/>
        <div id="slotsTable"></div>
        <br/>
        <h4>Current Patient</h4>
        <div id="patientJson"></div>
        <br/>
        <h4>Appointment</h4>
        <div id="appointmentJson"></div>
        <br/>
        <h4>Slot</h4>
        <div id="slotJson"></div>
        <br/>
        <h4>Schedule</h4>
        <div id="scheduleJson"></div>
        <br/>
        <h4>Slots</h4>
        <div id="slotsJson"></div>
        <br/>
        <h4>Appointments</h4>
        <div id="apptsJson"></div>        
    </body>
</html> 